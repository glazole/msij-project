# üìò –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—é MinIO + Spark + Iceberg + Jupyter –∏ –∑–∞–≥—Ä—É–∑–∫–µ ZIP-–∞—Ä—Ö–∏–≤–æ–≤ –≤ Iceberg

---
![alt text](ApacheIceberg.png)
---

## üîß 1. –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π (–≤ WSL2)

```bash
mkdir -p ~/msij-project/{conf,compose/docker/{spark,jupyter},minio,work/{scripts,notebooks}}
cd ~/msij-project
```

### üìÇ –û–ø–∏—Å–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π

* **conf/**
  –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `spark-defaults.conf`).

* **compose/**
  –§–∞–π–ª—ã –¥–ª—è Docker Compose –∏ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤.

  * **docker/spark/** ‚Äî Dockerfile –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (JAR'—ã) –¥–ª—è Spark.
  * **docker/jupyter/** ‚Äî Dockerfile –∏ –∫–æ–Ω—Ñ–∏–≥–∏ –¥–ª—è Jupyter.

> ‚ÑπÔ∏è **–í–∞–∂–Ω–æ:** –æ–±—Ä–∞–∑ Jupyter —Å–æ–∑–¥–∞—ë—Ç—Å—è –∏–∑ —Ç–æ–≥–æ –∂–µ –±–∞–∑–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞, —á—Ç–æ –∏ Spark (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–¥–Ω–∞ –∏ —Ç–∞ –∂–µ –≤–µ—Ä—Å–∏—è Spark).

* **minio/**
  –î–∞–Ω–Ω—ã–µ MinIO ‚Äî –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ, –≥–¥–µ —Å–æ–∑–¥–∞—é—Ç—Å—è S3-–±–∞–∫–µ—Ç—ã –¥–ª—è Iceberg.

* **work/**
  –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞.

  * **scripts/** ‚Äî Python-—Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è ETL/–æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö.
  * **notebooks/** ‚Äî Jupyter-–Ω–æ—É—Ç–±—É–∫–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –æ—Ç–ª–∞–¥–∫–∏.

---

### üå≥ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π (`tree`)

```text
msij-project/
‚îú‚îÄ‚îÄ conf/                     # –ö–æ–Ω—Ñ–∏–≥–∏ Spark, MinIO –∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ spark-defaults.conf
‚îÇ
‚îú‚îÄ‚îÄ compose/                  # Docker Compose –∏ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –æ–±—Ä–∞–∑—ã
‚îÇ   ‚îú‚îÄ‚îÄ docker/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ spark/            # Dockerfile –¥–ª—è Spark
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ jupyter/          # Dockerfile –¥–ª—è Jupyter
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îî‚îÄ‚îÄ docker-compose.yml    # –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –∑–∞–ø—É—Å–∫–∞
‚îÇ
‚îú‚îÄ‚îÄ minio/                    # –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ MinIO (–±–∞–∫–µ—Ç—ã)
‚îÇ
‚îî‚îÄ‚îÄ work/                     # –†–∞–±–æ—á–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –ø—Ä–æ–µ–∫—Ç–∞
    ‚îú‚îÄ‚îÄ scripts/              # Python-—Å–∫—Ä–∏–ø—Ç—ã
    ‚îÇ   ‚îî‚îÄ‚îÄ zip_to_iceberg_raw.py
    ‚îÇ
    ‚îî‚îÄ‚îÄ notebooks/            # Jupyter-–Ω–æ—É—Ç–±—É–∫–∏
        ‚îú‚îÄ‚îÄ etl_experiments.ipynb
        ‚îú‚îÄ‚îÄ iceberg_queries.ipynb
        ‚îî‚îÄ‚îÄ ...
```

## üê≥ 2. Docker Compose –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (MinIO, Spark, Jupyter)

**–§–∞–π–ª:** [`docker-compose.yml`](./compose/docker-compose.yml)

```yaml
services:
  minio:
    image: minio/minio
    ...
  mc:
    image: minio/mc
    depends_on:
      minio:
        condition: service_healthy
    ...
  spark-master:
    build: ./docker/spark
    image: local/spark:custom
    depends_on:
      minio:
        condition: service_healthy
      mc:
        condition: service_started
    ...
  spark-worker:
    image: local/spark:custom
    depends_on:
      spark-master:
        condition: service_started
    ...
  jupyter:
    build: ./docker/jupyter
    image: local/spark-jupyter:custom
    depends_on:
      spark-master:
        condition: service_started
    ...
volumes:
  spark-logs:
  minio-data:
```
---
* **minio** ‚Äî –æ–±—ä–µ–∫—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º S3, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ backend –¥–ª—è Iceberg.
* **mc** ‚Äî –∫–ª–∏–µ–Ω—Ç MinIO, –ø—Ä–∏–º–µ–Ω—è–µ–º—ã–π –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∫–µ—Ç–æ–≤ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–∞.
* **spark-master** ‚Äî —É–ø—Ä–∞–≤–ª—è—é—â–∏–π —É–∑–µ–ª –∫–ª–∞—Å—Ç–µ—Ä–∞ Spark, –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤–æ—Ä–∫–µ—Ä–æ–≤ –∏ –∑–∞–¥–∞—á.
* **spark-worker** ‚Äî —Ä–∞–±–æ—á–∏–µ —É–∑–ª—ã Spark, –≤—ã–ø–æ–ª–Ω—è—é—Ç –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏; –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç–æ—Ç –∂–µ –∫–∞—Å—Ç–æ–º–Ω—ã–π –æ–±—Ä–∞–∑, —á—Ç–æ –∏ –º–∞—Å—Ç–µ—Ä.
* **jupyter** ‚Äî –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∑–∞–ø—É—Å–∫–∞ Python-—Å–∫—Ä–∏–ø—Ç–æ–≤ –∏ –Ω–æ—É—Ç–±—É–∫–æ–≤, –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Spark —á–µ—Ä–µ–∑ `spark://spark-master:7077`.

---
üìå –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã –≤ –æ–¥–Ω—É —Å–µ—Ç—å, –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏ –ª–æ–≥–æ–≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã —Ç–æ–º–∞ `minio-data` –∏ `spark-logs` ‚Äî —ç—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—É—é –æ—Ç–ª–∞–¥–∫—É –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≥–∏–±–∫–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –ø—É—Ç–∏ `s3a://` –∏ Spark Session –∏–∑–Ω—É—Ç—Ä–∏ Jupyter –∏–ª–∏ .py-—Å–∫—Ä–∏–ø—Ç–æ–≤.

---
## ‚öôÔ∏è 3. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Spark

**–§–∞–π–ª:** [`spark-defaults.conf`](./conf/spark/spark-defaults.conf)

```conf
# –ö–ª–∞—Å—Ç–µ—Ä
spark.master                              spark://spark-master:7077
spark.driver.host                         jupyter

# S3A / MinIO
spark.hadoop.fs.s3a.endpoint              http://minio:9000
spark.hadoop.fs.s3a.access.key            minio
spark.hadoop.fs.s3a.secret.key            minio_minio
spark.hadoop.fs.s3a.path.style.access     true
spark.hadoop.fs.s3a.connection.ssl.enabled false

# Iceberg –∫–∞—Ç–∞–ª–æ–≥
spark.sql.extensions                      org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions
spark.sql.catalog.ice                     org.apache.iceberg.spark.SparkCatalog
spark.sql.catalog.ice.type                hadoop
spark.sql.catalog.ice.warehouse           s3a://warehouse/iceberg/
spark.sql.defaultCatalog                  ice

# –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å / —Ä–µ—Å—É—Ä—Å—ã
spark.serializer                          org.apache.spark.serializer.KryoSerializer
spark.sql.shuffle.partitions              48
spark.executor.instances                  1
spark.executor.cores                      1
spark.executor.memory                     2g
spark.driver.memory                       3g
spark.cores.max                           1

spark.dynamicAllocation.enabled           false

# –û—Ç–ª–∞–¥–æ—á–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
spark.driver.extraJavaOptions             -Duser.name=spark
spark.executor.extraJavaOptions           -Duser.name=spark
```
---

### üìò –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ [`spark-defaults.conf`](./conf/spark/spark-defaults.conf)

–§–∞–π–ª `spark-defaults.conf` —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Spark, –ø—Ä–∏–º–µ–Ω—è–µ–º—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Å—Å–∏–π –∫–∞–∫ –≤ Jupyter, —Ç–∞–∫ –∏ –∏–∑ CLI. –û–Ω –Ω—É–∂–µ–Ω –¥–ª—è:

* —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MinIO (—á–µ—Ä–µ–∑ `s3a`)
* –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞ Iceberg (—á–µ—Ä–µ–∑ `spark.sql.catalog.*`)
* –∑–∞–¥–∞–Ω–∏—è —Å—Ö–µ–º—ã –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ (executors, memory, cores)
* –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏, —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è, –æ—Ç–ª–∞–¥–∫–∏

–≠—Ç–æ—Ç —Ñ–∞–π–ª –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –≤ –∫–∞–∂–¥—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Spark (`master`, `worker`, `jupyter`), —á—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ –ø–æ–≤–µ–¥–µ–Ω–∏—è –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤–æ –≤—Å—ë–º –∫–ª–∞—Å—Ç–µ—Ä–µ.

---

### ‚öôÔ∏è –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º

#### üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MinIO

* `spark.hadoop.fs.s3a.endpoint` ‚Äî —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –∞–¥—Ä–µ—Å MinIO –≤–Ω—É—Ç—Ä–∏ docker-—Å–µ—Ç–∏.
* `spark.hadoop.fs.s3a.access.key` –∏ `secret.key` ‚Äî –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞.
* `path.style.access = true` ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è MinIO (—Ä–∞–±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ "path-style").
* `connection.ssl.enabled = false` ‚Äî –æ—Ç–∫–ª—é—á–∞–µ–º HTTPS, —Ç.–∫. —Ä–∞–±–æ—Ç–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ.

#### üì¶ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Iceberg-–∫–∞—Ç–∞–ª–æ–≥–∞

* `ice.warehouse = s3a://warehouse/iceberg/` ‚Äî –∫–∞—Ç–∞–ª–æ–≥, –≥–¥–µ Iceberg –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏ –¥–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü.
* `defaultCatalog = ice` ‚Äî –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ —Ç–∞–±–ª–∏—Ü–∞–º –∫–∞–∫ `ice.db.table`.

#### ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —Ä–µ—Å—É—Ä—Å—ã

Spark –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–ø—É—Å–∫–∞–µ—Ç **–æ–¥–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è (executor)** –Ω–∞ **–æ–¥–Ω–æ–º —è–¥—Ä–µ** –∏ —Å **2 –ì–ë –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏**. –≠—Ç–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏, –Ω–æ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–æ–ª—å—à–∏–º–∏ –∞—Ä—Ö–∏–≤–∞–º–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å —É–∑–∫–∏–º –º–µ—Å—Ç–æ–º.

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:

| –ü–∞—Ä–∞–º–µ—Ç—Ä                       | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ                                                            |
| ------------------------------ | -------- | ------------------------------------------------------------------- |
| `spark.executor.instances`     | `1`      | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π (processes) –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ                   |
| `spark.executor.cores`         | `1`      | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —è–¥–µ—Ä –Ω–∞ –æ–¥–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è                               |
| `spark.executor.memory`        | `2g`     | –û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å –¥–ª—è –æ–¥–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è                           |
| `spark.driver.memory`          | `3g`     | –ü–∞–º—è—Ç—å –¥–ª—è —É–ø—Ä–∞–≤–ª—è—é—â–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ (–¥—Ä–∞–π–≤–µ—Ä–∞)                         |
| `spark.sql.shuffle.partitions` | `48`     | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä—Ç–∏—Ü–∏–π –ø—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö shuffle (–Ω–∞–ø—Ä–∏–º–µ—Ä, join, groupBy) |

> ‚ö†Ô∏è **–í–∞–∂–Ω–æ:** Spark –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–µ –¥–ª—è –ø–∞–º—è—Ç–∏ executor‚Äô–∞, –º–æ–∂–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å —Å–±—Ä–æ—Å –Ω–∞ –¥–∏—Å–∫ –∏–ª–∏ –∞–≤–∞—Ä–∏–π–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ.

> üìò **Executor ‚â† Worker:**
> –û–¥–∏–Ω **executor** ‚Äî —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–π JVM-–ø—Ä–æ—Ü–µ—Å—Å, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–¥–∞—á–∏ Spark-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
> –û–¥–∏–Ω **worker** ‚Äî —ç—Ç–æ —É–∑–µ–ª (–∏–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä), –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –º–æ–≥—É—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è **–æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ executor‚Äô–æ–≤**.
> –í —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (1 worker + 1 executor) –≤—Å—ë –∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ –æ–¥–Ω–æ–º —É–∑–ª–µ, –Ω–æ –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏ –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ executor‚Äô–æ–≤ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö (–∏–ª–∏ —Ç–æ–º –∂–µ) worker‚Äô–∞—Ö ‚Äî –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤.

---

### üß† –ö–∞–∫ —Å–≤—è–∑–∞–Ω—ã worker, executor, core –∏ task

```text
        Spark Cluster (–Ω–∞ Docker –∏–ª–∏ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–º –∫–ª–∞—Å—Ç–µ—Ä–µ)
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                                                    ‚îÇ
        ‚îÇ  Spark Master                                      ‚îÇ
        ‚îÇ                                                    ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                       ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Spark Worker 1 ‚îÇ   ‚îÇ  Spark Worker 2 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ                       ‚îÇ
        ‚îÇ                       ‚îî‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                           ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Executor  ‚îÇ              ‚îÇ  Executor  ‚îÇ     (–ø–æ 1 –Ω–∞ worker)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§              ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Core 1    ‚îÇ              ‚îÇ  Core 1    ‚îÇ
‚îÇ  ‚îÄ Task A  ‚îÇ              ‚îÇ  ‚îÄ Task C  ‚îÇ
‚îÇ  Core 2    ‚îÇ              ‚îÇ  Core 2    ‚îÇ
‚îÇ  ‚îÄ Task B  ‚îÇ              ‚îÇ  ‚îÄ Task D  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

üß© –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞:

* **Worker** ‚Äî —ç—Ç–æ —É–∑–µ–ª –∫–ª–∞—Å—Ç–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ executor‚Äô–æ–≤.
* **Executor** ‚Äî JVM-–ø—Ä–æ—Ü–µ—Å—Å, –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞).
* **Core** ‚Äî –ª–æ–≥–∏—á–µ—Å–∫–æ–µ —è–¥—Ä–æ, –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–µ executor‚Äô—É.
* **Task** ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ —Ä–∞–±–æ—Ç—ã –≤ Spark (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ–≥–æ partition).

> üí° –í —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ `executor.instances = 1`, `executor.cores = 1`, –∏ –æ–¥–∏–Ω worker ‚Äî –∑–Ω–∞—á–∏—Ç, –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç –æ–¥–Ω—É JVM —Å –æ–¥–Ω–∏–º –ø–æ—Ç–æ–∫–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

---

üìò –ü—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏:

* –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ worker‚Äô–æ–≤ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –º–∞—à–∏–Ω–∞—Ö (–∏–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö),
* –∏–ª–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö executor‚Äô–æ–≤ –Ω–∞ –æ–¥–Ω–æ–º worker‚Äô–µ ‚Äî –µ—Å–ª–∏ —Ö–≤–∞—Ç–∞–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤.

---

### üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–æ–¥–±–æ—Ä—É —Ä–µ—Å—É—Ä—Å–æ–≤

* –î–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `4 cores` –∏ `4 GB` –ø–∞–º—è—Ç–∏ –Ω–∞ –æ–¥–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è.
* –ï—Å–ª–∏ –∑–∞–ø—É—Å–∫ –∏–¥—ë—Ç –Ω–∞ –æ–¥–Ω–æ–π –º–∞—à–∏–Ω–µ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ worker‚Äô–∞–º–∏, –æ–±—â–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –±—É–¥–µ—Ç:
  `num_workers √ó executor.memory + driver.memory`.
* –ù–∞–ø—Ä–∏–º–µ—Ä: 3 –≤–æ—Ä–∫–µ—Ä–∞ √ó 4–≥–± + 3–≥–± –¥—Ä–∞–π–≤–µ—Ä = **\~15 –ì–ë RAM**.

> üí° –°–ª–µ–¥–∏—Ç–µ –∑–∞ —Ç–µ–º, —á—Ç–æ–±—ã –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö `groupBy`, `join`, `distinct` –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ **–≥–∏–≥–∞–Ω—Ç—Å–∫–æ–≥–æ `shuffle`** (–ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É executor‚Äô–∞–º–∏) ‚Äî —ç—Ç–æ –æ–¥–Ω–∞ –∏–∑ –≥–ª–∞–≤–Ω—ã—Ö –ø—Ä–∏—á–∏–Ω –ø–∞–¥–µ–Ω–∏—è Spark-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –ø—Ä–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏.

### üîÅ Shuffle ‚Äî –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º–∏

**Shuffle** ‚Äî —ç—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º Spark **–ø–µ—Ä–µ–Ω–æ—Å–∏—Ç –¥–∞–Ω–Ω—ã–µ –º–µ–∂–¥—É executor‚Äô–∞–º–∏**, —á—Ç–æ–±—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏, —Ç—Ä–µ–±—É—é—â–∏–µ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∏–ª–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö, —Ö—Ä–∞–Ω—è—â–∏—Ö—Å—è –≤ —Ä–∞–∑–Ω—ã—Ö partition.

–ò–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏: –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø—ã (`groupBy`) –∏–ª–∏ —Å—Ç—Ä–æ–∫–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è (`join`) –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Ä–∞–∑–Ω—ã—Ö —á–∞—Å—Ç—è—Ö –¥–∞—Ç–∞—Ñ—Ä–µ–π–º–∞ ‚Äî –∏—Ö –Ω—É–∂–Ω–æ **–ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ –æ–¥–Ω–æ –º–µ—Å—Ç–æ**, –∞ –∑–Ω–∞—á–∏—Ç, –º–µ–∂–¥—É —É–∑–ª–∞–º–∏ (–∏–ª–∏ –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ ‚Äî –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏) –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è shuffle.

---

### üî• –û–ø–µ—Ä–∞—Ü–∏–∏, –≤—ã–∑—ã–≤–∞—é—â–∏–µ shuffle:

- `groupBy`, `groupByKey`, `reduceByKey`
- `join`, `cogroup`, `distinct`
- `orderBy`, `sort`, `repartition`, `coalesce`

---

### ‚öôÔ∏è –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ shuffle:

- Spark –¥–µ–ª–∏—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞ **partition‚Äô—ã**, –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥—Ä—É–≥–∏–º executor‚Äô–∞–º.
- –°–æ–∑–¥–∞—é—Ç—Å—è **–ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ñ–∞–π–ª—ã** –Ω–∞ –¥–∏—Å–∫ (shuffle files).
- –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–∑–∞–ø–∏—Å—å –∏ —á—Ç–µ–Ω–∏–µ –Ω–∞ –¥–∏—Å–∫**, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ.
- –≠—Ç–æ –º–æ–∂–µ—Ç **–ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å —Å–µ—Ç—å**, **–Ω–∞–≥—Ä—É–∂–∞—Ç—å –ø–∞–º—è—Ç—å** –∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å **—É–∑–∫–∏–µ –º–µ—Å—Ç–∞**.

---

### üìâ –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

| –ü—Ä–æ–±–ª–µ–º–∞                   | –ü—Ä–∏—á–∏–Ω–∞                         |
|---------------------------|---------------------------------|
| –ú–µ–¥–ª–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞           | –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ shuffle-–æ–ø–µ—Ä–∞—Ü–∏–π |
| OutOfMemory                | –ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ –ø–∞–º—è—Ç–∏ –Ω–∞ executor‚Äô–µ |
| –ü–µ—Ä–µ–≥—Ä–µ–≤ CPU/IO –¥–∏—Å–∫–∞      | –ë–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤       |
| "–ü–µ—Ä–µ–∫–æ—Å" (data skew)      | –ù–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–π |

---

### üß™ –í —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: `spark.sql.shuffle.partitions = 48`
- –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç: **–ø—Ä–∏ –∫–∞–∂–¥–æ–π shuffle-–æ–ø–µ—Ä–∞—Ü–∏–∏ Spark —Å–æ–∑–¥–∞—ë—Ç 48 –≤—ã—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π**, –≤–Ω–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞.
- `spark.dynamicAllocation.enabled = false` ‚Äî –∑–Ω–∞—á–∏—Ç, —á–∏—Å–ª–æ executor‚Äô–æ–≤ –Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Ä–æ—Å—Ç–µ –æ–±—ä—ë–º–∞ –¥–∞–Ω–Ω—ã—Ö (–∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å–µ–π –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã)
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è **–ª–æ–∫–∞–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ä–µ–¥–Ω–∏—Ö –∞—Ä—Ö–∏–≤–æ–≤**, –Ω–æ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ –±–æ–ª—å—à–∏–º –¥–∞–Ω–Ω—ã–º —Å—Ç–æ–∏—Ç:
  - —Å–ª–µ–¥–∏—Ç—å –∑–∞ "–ø–µ—Ä–µ–∫–æ—Å–æ–º" –∫–ª—é—á–µ–π (`data skew`)
  - –ø—Ä–æ–±–æ–≤–∞—Ç—å `repartition()` –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–¥ —Ç—è–∂—ë–ª—ã–º–∏ `groupBy`/`join`
  - —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –ø–∞–º—è—Ç—å/cores per executor –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

---

### ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

- –ù–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å `shuffle.partitions` —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–º (`>1000`) ‚Äî –±—É–¥–µ—Ç —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –º–∞–ª–µ–Ω—å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ –∏ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞ I/O.
- –ù–µ –¥–µ–ª–∞—Ç—å —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–º (`< num cores`) ‚Äî –Ω–∞—Ä—É—à–∞–µ—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å.
- –û–ø—Ç–∏–º–∞–ª—å–Ω–æ: `#shuffle partitions ‚âà #executor cores √ó 2‚Äì3`

---

üìå **–í—ã–≤–æ–¥:**  
Shuffle ‚Äî —ç—Ç–æ –æ–¥–∏–Ω –∏–∑ –≥–ª–∞–≤–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤, –≤–ª–∏—è—é—â–∏—Ö –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å Spark. –î–∞–∂–µ –Ω–∞ –æ–¥–Ω–æ–π –º–∞—à–∏–Ω–µ (–∏–ª–∏ –≤ Docker) –Ω–µ—Ä–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π shuffle –º–æ–∂–µ—Ç –∑–∞–º–µ–¥–ª–∏—Ç—å –≤—Å—ë –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∞–≤–∞—Ä–∏–∏. –ó–Ω–∞—á–µ–Ω–∏–µ `spark.sql.shuffle.partitions = 48` ‚Äî —Ä–∞–∑—É–º–Ω—ã–π –∫–æ–º–ø—Ä–æ–º–∏—Å—Å –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è.

---

üìå **–ü–æ—á–µ–º—É —Ç–∞–∫ —Å–¥–µ–ª–∞–ª:**
–§–∞–π–ª `spark-defaults.conf` –ø–æ–∑–≤–æ–ª—è–µ—Ç –≥–∏–±–∫–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –∫–∞–∫ —Ä–µ—Å—É—Ä—Å–∞–º–∏, —Ç–∞–∫ –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º Spark. –ë–ª–∞–≥–æ–¥–∞—Ä—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (Jupyter, Spark Master, Worker) –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –º–æ–≥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ MinIO –∏ –ø–∏—Å–∞—Ç—å –≤ Iceberg –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.

---
## üöÄ 4. –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏

### üîê –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞

–ö–∞—Ç–∞–ª–æ–≥ `work/`, –∫—É–¥–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç —Å–∫—Ä–∏–ø—Ç—ã, –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ –¥–∞–Ω–Ω—ã–µ, –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∏–∑ WSL –∏–ª–∏ Linux-—Ö–æ—Å—Ç–∞ –º–æ–∂–µ—Ç –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç—å **root**.  
–û–¥–Ω–∞–∫–æ Spark –≤ Bitnami-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å `uid = 1001`, –∏ –Ω–µ —Å–º–æ–∂–µ—Ç –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å —Ñ–∞–π–ª—ã –±–µ–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–∞–≤.

üìâ –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –æ—à–∏–±–∫–∞–º –≤–∏–¥–∞:
```text
Permission denied: Failed to create staging directory under /work...
```
–ò –ø–∞–¥–µ–Ω—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ.

---

### üõ† –†–µ—à–µ–Ω–∏–µ ‚Äî –≤—ã–¥–∞—Ç—å –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é `1001`

–í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º –∑–∞–ø—É—Å–∫–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:

```bash
sudo chown -R 1001:1001 /data/drug-forecast/work
sudo chmod -R u+rwX,g+rwX /data/drug-forecast/work
```

üìò –û–±—ä—è—Å–Ω–µ–Ω–∏–µ:

* `chown -R 1001:1001` ‚Äî –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–µ–º –ø–∞–ø–∫–∏ `work` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Spark –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.
* `chmod -R u+rwX,g+rwX` ‚Äî –¥–∞—ë—Ç –ø—Ä–∞–≤–∞ –Ω–∞ —á—Ç–µ–Ω–∏–µ, –∑–∞–ø–∏—Å—å –∏ –ø–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∏ –≥—Ä—É–ø–ø—ã (–±–µ–∑ –ª–∏—à–Ω–µ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –Ω–∞ `others`).

---

### ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∞–≤ –º–æ–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç `1001`:

```bash
ls -ld /home/glazole/first/data/drug-forecast/work
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

```text
drwxrwxr-x 5 1001 1001 4096 ... /home/glazole/first/data/drug-forecast/work
```
–ò–ª–∏:

```text
drwxrwxr-x 5 1001 docker 4096 ... /home/glazole/first/data/drug-forecast/work
```
---

### üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

–ï—Å–ª–∏ –≤—ã —É–∂–µ –∑–∞–ø—É—Å–∫–∞–ª–∏ `docker compose up -d`, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, —á—Ç–æ–±—ã –æ–Ω–∏ —É–≤–∏–¥–µ–ª–∏ –Ω–æ–≤—ã–µ –ø—Ä–∞–≤–∞:

```bash
docker compose up -d --force-recreate spark-master
```

* `--force-recreate` –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç Docker –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–∞–∂–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤.
* –ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–µ—Ä–≤–∏—Å—ã `spark`, `jupyter` –∏ —Ç.–ø., –µ—Å–ª–∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ç—Ä–æ–≥–∞—Ç—å `minio`.

---

### üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ UI

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ Spark Master UI –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É:

üîó [http://localhost:8080](http://localhost:8080)

–í –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å:

* –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–æ—Ä–∫–µ—Ä—ã,
* —Ä–µ—Å—É—Ä—Å—ã (cores, memory),
* –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ (–µ—Å–ª–∏ –±—ã–ª–∏),
* –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ).

---

üìå **–í—ã–≤–æ–¥:**
–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –ø—Ä–∞–≤ –Ω–∞ –º–æ–Ω—Ç–∏—Ä—É–µ–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —à–∞–≥ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏ Spark. –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç—ã, Jupyter-—Å–µ—Å—Å–∏–∏ –∏ Spark-–ø—Ä–æ—Ü–µ—Å—Å—ã —Å–º–æ–≥—É—Ç —Å–≤–æ–±–æ–¥–Ω–æ —á–∏—Ç–∞—Ç—å –∏ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ.

## üìí 5. –î–æ—Å—Ç—É–ø –∫ Jupyter –∏ Spark Web UI

### üìå JupyterLab: –ø–æ—Ä—Ç `8888`

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ Jupyter-—Å–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É:

üîó [http://localhost:8888](http://localhost:8888)

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é:

- –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ `jupyter`
- –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–∫–µ–Ω (—É–∫–∞–∑–∞–Ω –≤ –ª–æ–≥–∞—Ö –∏–ª–∏ –∑–∞–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `JUPYTER_TOKEN`)
- —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π PySpark-–∫–ª–∏–µ–Ω—Ç –∏ SparkSession, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –Ω–∞ `spark://spark-master:7077`

–ï—Å–ª–∏ `JUPYTER_TOKEN` –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ `docker-compose.yml`, –º–æ–∂–Ω–æ –∑–∞–π—Ç–∏ –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:

```yaml
environment:
  JUPYTER_TOKEN: "lab" # –≤ —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
```
---

### üî• Spark Web UI –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π: –ø–æ—Ä—Ç `4040`

–ö–æ–≥–¥–∞ –≤—ã –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ Spark-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ Jupyter (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ `SparkSession.builder.getOrCreate()`), Spark —Å–æ–∑–¥–∞—ë—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π **Web UI** –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞:

üîó [http://localhost:4040](http://localhost:4040)

Web UI –Ω–∞ `4040` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:

* DAG –∏ —Å—Ç–∞–¥–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (`Stages`, `Jobs`)
* —Ç–µ–∫—É—â–∏–µ –∏ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ (`Tasks`)
* –∏—Å–ø–æ–ª—å–∑—É–µ–º—É—é –ø–∞–º—è—Ç—å, –ø–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
* SQL-–∑–∞–ø—Ä–æ—Å—ã (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Spark SQL)
* –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è Spark

> ‚ö†Ô∏è –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞ –ø–æ—Ä—Ç—É `4040` –∞–∫—Ç–∏–≤–µ–Ω **—Ç–æ–ª—å–∫–æ –ø–æ–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç Spark-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (—Å–µ—Å—Å–∏—è)**. –ï—Å–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —è—á–µ–π–∫—É –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é ‚Äî –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.

---

### üß† –ü–æ–ª–µ–∑–Ω–æ –∑–Ω–∞—Ç—å

* –ü—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –∑–∞–ø—É—Å–∫–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö Spark-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, —Å–ª–µ–¥—É—é—â–∏–µ UI –±—É–¥—É—Ç –Ω–∞ `4041`, `4042` –∏ —Ç.–¥.
* –ï—Å–ª–∏ –ø–æ—Ä—Ç `4040` —É–∂–µ –∑–∞–Ω—è—Ç, Spark –≤—ã–±–µ—Ä–µ—Ç –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π (`4041+`)
* –í Jupyter —Ç–∞–∫–∂–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `%pyspark`, `%%spark`, `%%sql` (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã magics) –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã

---

üìå **–í—ã–≤–æ–¥:**
Jupyter –Ω–∞ –ø–æ—Ä—Ç—É `8888` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∑–∞–ø—É—Å–∫–∞ ETL-—Å–∫—Ä–∏–ø—Ç–æ–≤ –∏ –æ—Ç–ª–∞–¥–∫–∏,
–∞ Web UI –Ω–∞ `4040` –ø–æ–º–æ–≥–∞–µ—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å Spark-–∑–∞–¥–∞–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.

## üìå –≠—Ç–∞–ø—ã –ø—Ä–æ–µ–∫—Ç–∞: Spark + MinIO (–ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ Spark)

### ‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ

* [x] **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤** –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–∞: –¥–∞–Ω–Ω—ã–µ `raw` ‚Üí –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ `stage` ‚Üí –≤–∏—Ç—Ä–∏–Ω–∞ `warehouse`.
* [x] **MinIO —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç**, —Å–æ–∑–¥–∞–Ω—ã –±–∞–∫–µ—Ç—ã:

  * `raw` ‚Äì –∏—Å—Ö–æ–¥–Ω—ã–µ ZIP/CSV,
  * `stage` ‚Äì –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ Parquet,
  * `warehouse` ‚Äì —Ü–µ–ª–µ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã Iceberg.
* [x] **Spark Master + Worker** —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã, –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ Spark UI (–ø–æ—Ä—Ç 8080 –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞, 4040 –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π).
* [x] **Spark ‚Üî MinIO** –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `s3a://` –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ (—Ä–∞–±–æ—á–∏–µ –∫—Ä–µ–¥—ã –≤ `spark-defaults.conf`).

---

### üöÄ –ß—Ç–æ —Å–¥–µ–ª–∞–ª–∏ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ Spark

1. **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –∞—Ä—Ö–∏–≤–∞–º–∏ –≤ Spark-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä**

   * –í `docker-compose.yml` –ø—Ä–∏–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–ª–∏ –∫–∞—Ç–∞–ª–æ–≥ Windows/WSL (`/mnt/e/crpt_2025`) –≤–Ω—É—Ç—Ä—å Spark –∫–∞–∫ `/win_df`.
   * –¢–µ–ø–µ—Ä—å Spark –≤–∏–¥–∏—Ç ZIP-—Ñ–∞–π–ª—ã –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.

## üì¶ 6. –°–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∑–∫–∏ ZIP-–∞—Ä—Ö–∏–≤–æ–≤ –≤ Iceberg

**–§–∞–π–ª:** [`zip_to_iceberg_raw.py`](./work/scripts/zip_to_iceberg_raw.py)

### üîÑ –ê–ª–≥–æ—Ä–∏—Ç–º:

1. –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ ZIP-—Ñ–∞–π–ª—ã –∏–∑ `ZIP_DIR` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `/win_df` - –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø—Ä–æ–±—Ä–æ—à–µ–Ω–Ω–∞—è —Å–Ω–∞—Ä—É–∂–∏)
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ ZIP:

   * –ò–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è **–ø–µ—Ä–≤—ã–π .csv** —Ñ–∞–π–ª –≤ tmp-–ø–∞–ø–∫—É
   * CSV —á–∏—Ç–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `spark.read.csv`
   * –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü—ã `bronze.crpt_2025_raw` –Ω–µ—Ç ‚Äî –æ–Ω–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è
   * –î–∞–Ω–Ω—ã–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è (`append`)
   * –§–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤ –ª–æ–≥: `bronze.crpt_load_log`
3. –í –∫–æ–Ω—Ü–µ ‚Äî —Å–≤–æ–¥–∫–∞ (—Å–∫–æ–ª—å–∫–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ / –ø—Ä–æ–ø—É—â–µ–Ω–æ / —Å –æ—à–∏–±–∫–æ–π)
4. –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∑–∞–ø—É—Å–∫–µ, —Å–≤–µ—Ä—è–µ—Ç—Å—è —Å –ª–æ–≥-—Ç–∞–±–ª–∏—Ü–µ–π, –µ—Å–ª–∏ —Ä–∞–Ω–µ–µ —Ç–∞–∫–æ–π —Ñ–∞–π–ª –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª—Å—è, –æ–Ω –ø–æ—Å—Ç—É–ø–∞–µ—Ç –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É, –∏–Ω–∞—á–µ - –æ—Å—Ç–∞–Ω–æ–≤–∫–∞.

üìå *–ü–æ—á–µ–º—É —Ç–∞–∫*:

* –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –∏ max —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ‚Äî —Ñ–∞–π–ª —á–∏—Ç–∞–µ—Ç—Å—è ¬´–ø–æ—Ç–æ–∫–æ–≤–æ¬ª (—á–µ—Ä–µ–∑ `shutil.copyfileobj`)
* –°—Ö–µ–º–∞ CSV –Ω–µ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `inferSchema`
* –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏—Å–∫–ª—é—á–∞–µ—Ç—Å—è –±–ª–∞–≥–æ–¥–∞—Ä—è `bronze.crpt_load_log`

---

–û—Ç–ª–∏—á–Ω–æ üëç –ù–∏–∂–µ ‚Äî –∫—Ä–∞—Å–∏–≤–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã–π –∏ –ø–æ—è—Å–Ω—ë–Ω–Ω—ã–π –±–ª–æ–∫ **üß™ 7. –ü—Ä–∏–º–µ—Ä –∑–∞–ø—É—Å–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞**, —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ **–≤—Ç–æ—Ä–æ–π –≤–∞—Ä–∏–∞–Ω—Ç**, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª. –Ø —Ç–∞–∫–∂–µ –¥–æ–±–∞–≤–∏–ª –ø–æ—è—Å–Ω–µ–Ω–∏–µ –∫ –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥–µ: –∑–∞—á–µ–º `--master local[2]`, –∑–∞—á–µ–º `PYTHONUNBUFFERED=1`, –∏ –∫–æ–≥–¥–∞ —Å—Ç–æ–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫–æ–π –≤–∞—Ä–∏–∞–Ω—Ç.

---

## üß™ 7. –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—É—Å–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ZIP-–∞—Ä—Ö–∏–≤–æ–≤

–°–∫—Ä–∏–ø—Ç [`zip_to_iceberg_raw.py`](./work/scripts/zip_to_iceberg_raw.py) –∑–∞–≥—Ä—É–∂–∞–µ—Ç CSV-—Ñ–∞–π–ª—ã –∏–∑ ZIP-–∞—Ä—Ö–∏–≤–æ–≤ –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∏—Ö –≤ —Ç–∞–±–ª–∏—Ü—É Iceberg, —Ö—Ä–∞–Ω—è—â—É—é—Å—è –≤ MinIO (`s3a://warehouse/iceberg/...`).

---

### ‚ñ∂Ô∏è –í–∞—Ä–∏–∞–Ω—Ç 1: –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ `spark-submit` —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Spark-–∫–ª–∞—Å—Ç–µ—Ä–∞

```bash
docker compose exec spark-master \
  spark-submit --master spark://spark-master:7077 \
  /work/zip_to_iceberg_raw.py
```

üìò –ó–¥–µ—Å—å Spark-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –æ—Ç –∏–º–µ–Ω–∏ Spark Master (`--master spark://...`), –∏ –∑–∞–¥–∞—á–∏ –±—É–¥—É—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –º–µ–∂–¥—É –≤—Å–µ–º–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ worker‚Äô–∞–º–∏. –≠—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—É—Ç—å –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞.

---

### ‚úÖ –í–∞—Ä–∏–∞–Ω—Ç 2 (–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –≤ –ø—Ä–æ–µ–∫—Ç–µ): –∑–∞–ø—É—Å–∫ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏

```bash
docker compose exec -e PYTHONUNBUFFERED=1 spark-master \
  spark-submit --master local[2] \
  --conf spark.driver.memory=6g \
  --conf spark.executor.memory=6g \
  /work/zip_to_iceberg_raw.py
```

üß© **–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:**

* `--master local[2]`
  –ó–∞–ø—É—Å–∫–∞–µ—Ç Spark –≤ **–ª–æ–∫–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ** (–±–µ–∑ Master/Worker –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã), –∏—Å–ø–æ–ª—å–∑—É—è **2 –ø–æ—Ç–æ–∫–∞** –Ω–∞ –æ–¥–Ω–æ–π –º–∞—à–∏–Ω–µ. –≠—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç –∑–∞–ø—É—Å–∫ –∏ —ç–∫–æ–Ω–æ–º–∏—Ç —Ä–µ—Å—É—Ä—Å—ã –ø—Ä–∏ –æ—Ç–ª–∞–¥–∫–µ –∏–ª–∏ –∑–∞–ø—É—Å–∫–µ –≤ –æ–¥–Ω–æ–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

* `--conf spark.driver.memory=6g`
  –í—ã–¥–µ–ª—è–µ—Ç **6 –ì–ë –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏** –¥–ª—è Spark-–¥—Ä–∞–π–≤–µ—Ä–∞ (—É–ø—Ä–∞–≤–ª—è—é—â–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞).

* `--conf spark.executor.memory=6g`
  –í—ã–¥–µ–ª—è–µ—Ç **6 –ì–ë –ø–∞–º—è—Ç–∏** –¥–ª—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è (executor), –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ.

* `-e PYTHONUNBUFFERED=1`
  –£–±–∏—Ä–∞–µ—Ç –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—é –≤—ã–≤–æ–¥–∞ Python –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ‚Üí –ª–æ–≥–∏ —Å—Ä–∞–∑—É –≤–∏–¥–Ω—ã –≤ –∫–æ–Ω—Å–æ–ª–∏. –ü–æ–ª–µ–∑–Ω–æ –ø—Ä–∏ –æ—Ç–ª–∞–¥–∫–µ.

---

### üß™ –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫–æ–π –≤–∞—Ä–∏–∞–Ω—Ç?

| –í–∞—Ä–∏–∞–Ω—Ç                            | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å                               |
| ---------------------------------- | ------------------------------------------------ |
| `--master spark://...`             | –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ Spark-–∫–ª–∞—Å—Ç–µ—Ä–∞    |
| `--master local[n]`                | –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏ –∏–ª–∏ –∑–∞–ø—É—Å–∫–∞ –≤ 1 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ |
| `driver.memory`, `executor.memory` | –ö–æ–≥–¥–∞ –Ω—É–∂–Ω—ã —Ä–µ—Å—É—Ä—Å—ã –¥–ª—è –±–æ–ª—å—à–∏—Ö –∞—Ä—Ö–∏–≤–æ–≤          |

---

üìå **–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ–¥—Ö–æ–¥:**
–ï—Å–ª–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—à—å –¥–µ—Å—è—Ç–∫–∏ ZIP-–∞—Ä—Ö–∏–≤–æ–≤ —Å –±–æ–ª—å—à–∏–º–∏ CSV-—Ñ–∞–π–ª–∞–º–∏ ‚Äî **–ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç—å—é**, –∫–∞–∫ –≤–æ –≤—Ç–æ—Ä–æ–º –ø—Ä–∏–º–µ—Ä–µ. –≠—Ç–æ –ø—Ä–æ—â–µ, —á–µ–º –∑–∞–ø—É—Å–∫–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ worker‚Äô—ã, –∏ –¥–∞—ë—Ç –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Ä–µ—Å—É—Ä—Å–∞–º–∏.

---

## üß† 8. –ß—Ç–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü Iceberg –≤ Jupyter

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ (—á–µ—Ä–µ–∑ `zip_to_iceberg_raw.py`) –º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Spark –∏–∑ Jupyter –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

- –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Iceberg-–∫–∞—Ç–∞–ª–æ–≥–∞,
- –Ω–∞–ª–∏—á–∏–µ —Å—Ö–µ–º –∏ —Ç–∞–±–ª–∏—Ü,
- —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–∞–±–ª–∏—Ü—ã.

---

### ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Spark

```python
from pyspark.sql import SparkSession

spark = (
    SparkSession.builder
    .appName("Check Iceberg")
    .getOrCreate()
)
```

> –í —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `spark-defaults.conf`, –ø–æ—ç—Ç–æ–º—É Spark –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Iceberg-–∫–∞—Ç–∞–ª–æ–≥—É `ice` (—Ç–∏–ø: `hadoop`, warehouse: `s3a://warehouse/iceberg/`).

---

### üìö –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö (—Å—Ö–µ–º)

```python
spark.catalog.listDatabases()
```

üëÄ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

```text
[Database(name='bronze', ...), Database(name='default', ...)]
```

---

### üóÉÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü –≤ —Å—Ö–µ–º–µ `bronze`

```python
spark.catalog.listTables("bronze")
```

üëÄ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

```text
[Table(name='crpt_2025_raw', tableType='MANAGED', ...),
 Table(name='crpt_load_log', tableType='MANAGED', ...)]
```

---

### üìÑ –ß—Ç–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø–æ namespace

```python
df = spark.table("ice.bronze.crpt_2025_raw")
df.show(5)
```

–ò–ª–∏ —á–µ—Ä–µ–∑ SQL:

```python
spark.sql("SELECT * FROM ice.bronze.crpt_2025_raw LIMIT 5").show()
```

---

### üìÇ –ß—Ç–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø–æ –∞–±—Å–æ–ª—é—Ç–Ω–æ–º—É –ø—É—Ç–∏

```python
df = spark.read.format("iceberg").load("s3a://warehouse/iceberg/bronze/crpt_2025_raw")
df.show(5)
```

üìå **–ü–æ—á–µ–º—É —Ç–∞–∫:**
Spark 3.5 + Iceberg 1.6 –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –∫–∞–∫ —Ñ–æ—Ä–º–∞—Ç—ã `ice.db.table`, —Ç–∞–∫ –∏ –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –ø—É—Ç–∏ —á–µ—Ä–µ–∑ `s3a://...`.
–ê–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–µ–Ω –ø—Ä–∏ –æ—Ç–ª–∞–¥–∫–µ, –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –∏–ª–∏ –ø–æ–¥–∫–∞—Ç–∞–ª–æ–≥, –º–∏–Ω—É—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∞.

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ —á–µ—Ä–µ–∑ MinIO Client

```bash
mc alias set localminio http://localhost:9000 minio minio_minio
mc ls localminio/warehouse/iceberg/bronze/
```

–ü–æ–∑–≤–æ–ª—è–µ—Ç —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ `crpt_2025_raw` –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ñ–∞–π–ª–æ–≤ (Parquet + metadata JSON/AVRO + snapshot files).

---

## üìå –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç               | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                                 |
| ----------------------- | ---------------------------------------------------------- |
| WSL2 + Docker           | –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º Linux –æ–∫—Ä—É–∂–µ–Ω–∏–µ–º |
| MinIO                   | –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç S3-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è Iceberg                      |
| Spark + Iceberg         | ETL-–¥–≤–∏–∂–æ–∫ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü —Å –≤–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç—å—é               |
| Jupyter                 | UI –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–∫—Ä–∏–ø—Ç–æ–≤ –∏ –æ—Ç–ª–∞–¥–∫–∏                          |
| `zip_to_iceberg_raw.py` | –°–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∑–∫–∏ ZIP-–∞—Ä—Ö–∏–≤–æ–≤ –≤ Iceberg —Ç–∞–±–ª–∏—Ü—É              |

---

üìò **–ò—Ç–æ–≥:**
–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å –∞—Ä—Ö–∏–≤—ã –≤ Iceberg-—Ç–∞–±–ª–∏—Ü—ã, –∞ –∑–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∏—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–∞–∫ –∏–∑ Jupyter, —Ç–∞–∫ –∏ —á–µ—Ä–µ–∑ Spark CLI. –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Å –≤–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç—å—é –≤ `s3a://warehouse/iceberg/bronze/...`, —á—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É —Ä–∞—Å—à–∏—Ä—è–µ–º–æ–π –∏ –ø—Ä–∏–≥–æ–¥–Ω–æ–π –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏–ª–∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏.

---
